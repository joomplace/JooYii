jQuery( document ).ready(function() {
 
    //Work area
    jQuery(".ddupload_field").each(function() {
        setWatcher(jQuery(this));
    });

    jQuery(document).on('dragenter', function (e)
    {
        e.stopPropagation();
        e.preventDefault();
    });
    jQuery(document).on('drop', function (e)
    {
        e.stopPropagation();
        e.preventDefault();
    });

    //Check drags events
    function setWatcher(obj) {

        var singleArray = jQuery(obj).find('.thumbsData').val()?jQuery(obj).find('.thumbsData').val().split("|"):[];
        jQuery(document).on('dragover', function (e)
        {
            e.stopPropagation();
            e.preventDefault();
            obj.css('border', '2px dotted #0B85A1');
        });

        obj.on('dragenter', function (e)
        {
            e.stopPropagation();
            e.preventDefault();
            jQuery(obj).css('border', '2px solid #0B85A1');
        });
        obj.on('dragover', function (e)
        {
            e.stopPropagation();
            e.preventDefault();
        });
        obj.on('drop', function (e)
        {
            jQuery(obj).css('border', '2px dotted #0B85A1');
            e.preventDefault();
            var files = e.originalEvent.dataTransfer.files;

            handleFileUpload(files,obj);
        });
        jQuery(obj).find('input[type=file]').change(function() {
            var fd = new FormData();
            fd.append('file', this.files[0]);
            sendFileToServer(fd, obj.data('upurl'), status);
        });
        jQuery(obj).find('.file_close').click(function () {
            id = jQuery(this).attr('data-file');
            console.log(id);
            jQuery(this).parent().remove();
            deleteFileFromArray(id);
            insertFilesArrayToField();
        });

        function handleFileUpload(files, obj)
        {
            for (var i = 0; i < files.length; i++)
            {
                var fd = new FormData();
                fd.append('file', files[i]);
                sendFileToServer(fd, obj.data('upurl'), status);
            }
        }
        function deleteFileFromArray (id) {
            delete singleArray[id];
            if (singleArray[id] == undefined) return true;
            else return false;
        }

        function insertFilesArrayToField() {
            string = singleArray.join('|');
            out = jQuery(obj).find('.thumbsData').val(string);
        }

        //Check Element On Unique
        function CheckElementOnUnique(value) {
            array = singleArray;

            for (var i = 0; i < array.length; i++) {
                if (array[i] == value) return false;
            }

            return true;
        }

        //Send Files
        function sendFileToServer(formData, uploadURL)
        {

            var jqXHR=jQuery.ajax({
                url: uploadURL,
                type: "POST",
                contentType:false,
                processData: false,
                cache: false,
                data: formData,
                success: function(data){
                    var txt = data;
                    var file_outer = jQuery('<div class="file_outter">');
                    var file_close = jQuery('<div class="file_close" data-file="'+(singleArray.length)+'">');
                    var file = jQuery(data).find('i').text();
                    data = jQuery(data);
                    data.find('i').text('');
                    if(data.find('i').length){
                        if (CheckElementOnUnique(file)) {
                            //Check uploads errors

                            file_close.appendTo(file_outer);
                            jQuery(data).appendTo(file_outer);
                            file_outer.appendTo(jQuery(obj).find('.files_container'));
                            file_close.html('&times');
                            if (jQuery(obj).find('.thumbsData').attr('data-multiple')) {
                                jQuery(file_outer).prev().remove();
                                singleArray.push(file);
                            }else {

                                singleArray[0] = file;
                            }
                            //Add delete event for new close element
                            jQuery(file_close).click(function () {
                                id = jQuery(this).attr('data-file');
                                jQuery(this).parent().remove();
                                deleteFileFromArray(id);
                                insertFilesArrayToField();
                            });
                            insertFilesArrayToField();
                        }
                        else alert('File already uploaded');
                    }else alert(txt);
                }
            });
        }
    }

});
